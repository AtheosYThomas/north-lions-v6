rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    // Check if the user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if the user is the owner of the document (based on UID)
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if the user is an Admin
    // We assume the user's role is stored in /members/{uid} under field `system.role`
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/members/$(request.auth.uid)).data.system.role == 'admin';
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }

    // --- Collection Rules ---

    // 1. Members
    match /members/{userId} {
      // Directory is open to members (authenticated users)
      allow read: if isAuthenticated();
      // Write allowed if user is owner OR admin
      allow write: if isOwner(userId) || isAdmin();
    }

    // 2. Announcements
    match /announcements/{announcementId} {
      // Read allowed for authenticated users
      allow read: if isAuthenticated();
      // Write allowed for admins only
      allow write: if isAdmin();
    }

    // 3. Events
    match /events/{eventId} {
      // Read allowed for authenticated users
      allow read: if isAuthenticated();
      // Write allowed for admins only
      allow write: if isAdmin();
    }

    // 4. Registrations
    match /registrations/{registrationId} {
      // Read allowed if user is owner (of the registration info) OR admin
      allow read: if isAuthenticated() && (
        resource.data.info.memberId == request.auth.uid || isAdmin()
      );
      // Write allowed if user is owner (creating/updating their own) OR admin
      allow write: if isAuthenticated() && (
        request.resource.data.info.memberId == request.auth.uid || isAdmin()
      );
    }

    // 5. Donations
    match /donations/{donationId} {
      // Read allowed if user is owner (of the donation record) OR admin
      allow read: if isAuthenticated() && (
        resource.data.memberId == request.auth.uid || isAdmin()
      );
      // Write allowed for admins only (Donations are usually recorded by admins/system)
      allow write: if isAdmin();
    }

    // 6. Payments
    match /payments/{paymentId} {
      // Read allowed if user is owner (of the payment record) OR admin
      allow read: if isAuthenticated() && (
        resource.data.related.memberId == request.auth.uid || isAdmin()
      );
      // Write allowed for admins only
      allow write: if isAdmin();
    }

    // 7. Message Logs
    match /message_logs/{messageId} {
      // Only admins can read/write message logs
      allow read, write: if isAdmin();
    }
  }
}
